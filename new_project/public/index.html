<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Монитор линий</title>
  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/theme.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
  <div id="app" class="p-4">
    <div class="flex flex-col md:flex-row gap-4">
      <!-- Left column: list of lines and settings button -->
      <div class="w-full md:w-1/4">
        <h2 class="text-lg font-bold mb-2">Линии</h2>
        <div id="linesList" class="flex flex-col gap-2"></div>
        <button id="settingsBtn" class="mt-4 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">Настройки</button>
      </div>
      <!-- Right column: charts -->
      <div class="flex-1">
        <h2 id="lineTitle" class="text-lg font-bold mb-2">Скорость</h2>
        <div class="bg-white p-4 rounded shadow">
          <canvas id="speedChart"></canvas>
        </div>
        <h2 class="text-lg font-bold mt-6 mb-2">Работа / Простой (30 дней)</h2>
        <div class="bg-white p-4 rounded shadow">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentLine = null;
    let speedChart = null;
    let dailyChart = null;

    // Create charts on first load
    function createCharts() {
      const ctx1 = document.getElementById('speedChart').getContext('2d');
      speedChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Скорость (см/мин)',
              data: [],
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.2)',
              pointRadius: 0,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'см/мин' },
            },
          },
          plugins: {
            legend: { display: false },
          },
        },
      });
      const ctx2 = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Работа (ч)',
              data: [],
              backgroundColor: '#16a34a',
            },
            {
              label: 'Простой (ч)',
              data: [],
              backgroundColor: '#dc2626',
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              title: { display: true, text: 'Часы' },
            },
          },
        },
      });
    }

    // Load the current status for all lines and populate the list
    async function loadStatus() {
      try {
        const res = await fetch('/status');
        const lines = await res.json();
        const container = document.getElementById('linesList');
        container.innerHTML = '';
        lines.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'p-2 bg-white rounded shadow flex justify-between items-center cursor-pointer';
          div.dataset.lineId = item.lineId;
          const name = item.displayName || item.lineId;
          const stateLabel = item.stateLabel;
          const speed = (item.speed && !isNaN(item.speed)) ? item.speed.toFixed(1) : '-';
          const product = item.product || '';
          div.innerHTML = `
            <div>
              <div class="font-semibold">${name}</div>
              <div class="text-sm text-gray-500">${stateLabel}</div>
              <div class="text-xs text-gray-400">Изделие: ${product || '-'}</div>
            </div>
            <div class="text-right">
              <div class="font-mono">${speed}</div>
            </div>
          `;
          div.addEventListener('click', () => {
            selectLine(item.lineId);
          });
          if (currentLine === null) {
            currentLine = item.lineId;
          }
          container.appendChild(div);
        });
        // Highlight the selected line
        Array.from(container.children).forEach((child) => {
          child.classList.remove('border', 'border-blue-500');
          if (child.dataset.lineId === currentLine) {
            child.classList.add('border', 'border-blue-500');
          }
        });
      } catch (e) {
        console.error('loadStatus', e);
      }
    }

    // Change the selected line and refresh charts
    async function selectLine(lineId) {
      currentLine = lineId;
      await updateCharts();
      // update highlight
      const container = document.getElementById('linesList');
      Array.from(container.children).forEach((child) => {
        child.classList.remove('border', 'border-blue-500');
        if (child.dataset.lineId === lineId) {
          child.classList.add('border', 'border-blue-500');
        }
      });
    }

    // Fetch chart data for the current line and update both charts
    async function updateCharts() {
      if (!currentLine) return;
      try {
        const res = await fetch('/chartdata/' + currentLine);
        const data = await res.json();
        // Speed chart
        speedChart.data.labels = data.speed.labels;
        speedChart.data.datasets[0].data = data.speed.data;
        speedChart.update();
        // Daily chart
        dailyChart.data.labels = data.status.labels;
        dailyChart.data.datasets[0].data = data.status.work;
        dailyChart.data.datasets[1].data = data.status.down;
        dailyChart.update();
        document.getElementById('lineTitle').textContent = `${data.status.lineName || currentLine} — скорость`;
      } catch (e) {
        console.error('updateCharts', e);
      }
    }

    // Periodically refresh status and charts
    async function periodic() {
      await loadStatus();
      await updateCharts();
      setTimeout(periodic, 15000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      createCharts();
      loadStatus().then(() => {
        selectLine(currentLine);
      });
      periodic();
      document.getElementById('settingsBtn').addEventListener('click', () => {
        window.location.href = '/settings';
      });
    });
  </script>
</body>
</html>
new_project/public/login.html
Новый
+21
-0

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вход</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/theme.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded shadow w-80">
    <h1 class="text-xl font-bold mb-4 text-center">Вход</h1>
    <form method="post" action="/login" class="space-y-4">
      <input type="text" name="username" placeholder="Логин" class="w-full border p-2 rounded" required />
      <input type="password" name="password" placeholder="Пароль" class="w-full border p-2 rounded" required />
      <label class="flex items-center"><input type="checkbox" name="remember" class="mr-2" />Запомнить меня</label>
      <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">Войти</button>
    </form>
  </div>
</body>
</html>
new_project/public/settings.html
Новый
+202
-0

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Настройки</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/theme.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">Настройки</h1>
  <label class="flex items-center gap-2 mb-4">
    <span>Тёмная тема</span>
    <input type="checkbox" id="themeToggle" />
  </label>
  <!-- Authentication form -->
  <div id="authForm" class="space-y-4">
    <p>Введите пароль для доступа к настройкам:</p>
    <input type="password" id="authPass" class="border p-2 rounded w-64" placeholder="Пароль" />
    <button id="authSubmit" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">Войти</button>
    <p id="authError" class="text-red-600 hidden">Неверный пароль</p>
  </div>
  <!-- Settings form -->
  <div id="settingsForm" class="space-y-4 hidden">
    <label class="block">Окно усреднения (сек):
      <input id="windowSec" type="number" min="1" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Время (сек), за которое усредняется скорость. Чем больше значение, тем плавнее график.</span>
    </label>
    <label class="block">Порог запуска V_START (см/мин):
      <input id="V_START" type="number" step="0.1" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Если усреднённая скорость превышает этот порог в течение delayStart, линия считается запущенной.</span>
    </label>
    <label class="block">Порог остановки V_STOP (см/мин):
      <input id="V_STOP" type="number" step="0.1" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Если усреднённая скорость падает ниже этого порога в течение delayStop, линия считается остановленной.</span>
    </label>
    <label class="block">Задержка запуска (сек):
      <input id="delayStart" type="number" min="0" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Минимальное время, в течение которого скорость должна быть выше V_START, чтобы зафиксировать запуск.</span>
    </label>
    <label class="block">Задержка остановки (сек):
      <input id="delayStop" type="number" min="0" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Минимальное время, в течение которого скорость должна быть ниже V_STOP, чтобы зафиксировать остановку.</span>
    </label>
    <label class="block">Глубина графика (часы):
      <select id="graphHours" class="border p-2 rounded ml-2 w-32">
        <option value="24">24</option>
        <option value="48">48</option>
      </select>
      <span class="text-xs text-gray-500 block">Период, отображаемый на графике скорости.</span>
    </label>
    <label class="block">Тайм‑аут ожидания пакета (сек):
      <input id="offlineTimeout" type="number" min="1" class="border p-2 rounded ml-2 w-32" />
      <span class="text-xs text-gray-500 block">Если пакеты не приходят дольше этого времени, линия считается остановленной.</span>
    </label>
    <label class="block">Telegram Token:
      <input id="telegramToken" type="text" class="border p-2 rounded ml-2 w-64" />
      <span class="text-xs text-gray-500 block">Токен бота для отправки уведомлений (оставьте пустым, чтобы отключить).</span>
    </label>
    <label class="block">Telegram Chat ID:
      <input id="telegramChatId" type="text" class="border p-2 rounded ml-2 w-64" />
      <span class="text-xs text-gray-500 block">ID чата, куда отправлять уведомления.</span>
    </label>
    <div>
      <h2 class="font-semibold mt-4 mb-2">Линии</h2>
      <div id="linesConfig" class="space-y-2"></div>
    </div>
    <button id="saveBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">Сохранить</button>
    <p id="saveMsg" class="text-green-600 hidden">Настройки сохранены</p>
  </div>
  <script>
    async function checkAuth() {
      try {
        const res = await fetch('/settings/info');
        if (res.status === 200) {
          const data = await res.json();
          document.getElementById('authForm').classList.add('hidden');
          document.getElementById('settingsForm').classList.remove('hidden');
          loadSettings(data);
        } else if (res.status === 401) {
          document.getElementById('authForm').classList.remove('hidden');
          document.getElementById('settingsForm').classList.add('hidden');
        }
      } catch (e) {
        console.error('checkAuth', e);
      }
    }
    function loadSettings(data) {
      document.getElementById('windowSec').value = data.windowSec;
      document.getElementById('V_START').value = data.V_START;
      document.getElementById('V_STOP').value = data.V_STOP;
      document.getElementById('delayStart').value = data.delayStart;
      document.getElementById('delayStop').value = data.delayStop;
      document.getElementById('graphHours').value = data.graphHours;
      document.getElementById('offlineTimeout').value = data.offlineTimeout || 60;
      document.getElementById('telegramToken').value = data.telegramToken || '';
      document.getElementById('telegramChatId').value = data.telegramChatId || '';
      // Build lines configuration
      const linesDiv = document.getElementById('linesConfig');
      linesDiv.innerHTML = '';
      const enabled = data.enabledLines || [];
      const names = data.lineNames || {};
      const products = data.products || {};
      for (let i = 1; i <= 13; i++) {
        const id = 'line' + i;
        const row = document.createElement('div');
        row.className = 'flex flex-wrap items-center gap-2';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'en_' + id;
        checkbox.checked = enabled.includes(id);
        const label = document.createElement('label');
        label.htmlFor = 'en_' + id;
        label.textContent = id;
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.id = 'name_' + id;
        nameInput.value = names[id] || '';
        nameInput.placeholder = id;
        nameInput.className = 'border p-1 rounded flex-1';
        const prodInput = document.createElement('input');
        prodInput.type = 'text';
        prodInput.id = 'prod_' + id;
        prodInput.value = products[id] || '';
        prodInput.placeholder = 'Изделие';
        prodInput.className = 'border p-1 rounded flex-1';
        row.appendChild(checkbox);
        row.appendChild(label);
        row.appendChild(nameInput);
        row.appendChild(prodInput);
        linesDiv.appendChild(row);
      }
    }
    async function authenticate() {
      const pass = document.getElementById('authPass').value;
      try {
        const res = await fetch('/settings/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pass }),
        });
        if (res.status === 200) {
          document.getElementById('authError').classList.add('hidden');
          checkAuth();
        } else {
          document.getElementById('authError').classList.remove('hidden');
        }
      } catch (e) {
        console.error('authenticate', e);
      }
    }
    async function saveSettings() {
      const cfg = {};
      cfg.windowSec = Number(document.getElementById('windowSec').value) || 60;
      cfg.V_START = Number(document.getElementById('V_START').value) || 0.5;
      cfg.V_STOP = Number(document.getElementById('V_STOP').value) || 0.3;
      cfg.delayStart = Number(document.getElementById('delayStart').value) || 30;
      cfg.delayStop = Number(document.getElementById('delayStop').value) || 30;
      cfg.graphHours = Number(document.getElementById('graphHours').value) || 24;
      cfg.offlineTimeout = Number(document.getElementById('offlineTimeout').value) || 60;
      cfg.enabledLines = [];
      cfg.lineNames = {};
      for (let i = 1; i <= 13; i++) {
        const id = 'line' + i;
        const enabled = document.getElementById('en_' + id).checked;
        if (enabled) cfg.enabledLines.push(id);
        const nameVal = document.getElementById('name_' + id).value.trim();
        cfg.lineNames[id] = nameVal;
      }
      // collect product assignments
      cfg.products = {};
      for (let i = 1; i <= 13; i++) {
        const id = 'line' + i;
        const prodVal = document.getElementById('prod_' + id).value.trim();
        cfg.products[id] = prodVal;
      }
      // Telegram credentials
      cfg.telegramToken = document.getElementById('telegramToken').value.trim();
      cfg.telegramChatId = document.getElementById('telegramChatId').value.trim();
      try {
        const res = await fetch('/settings/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cfg),
        });
        if (res.status === 200) {
          document.getElementById('saveMsg').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('saveMsg').classList.add('hidden');
          }, 3000);
        }
      } catch (e) {
        console.error('saveSettings', e);
      }
    }
    document.getElementById('authSubmit').addEventListener('click', authenticate);
    document.getElementById('saveBtn').addEventListener('click', saveSettings);
    initThemeToggle('themeToggle');
    checkAuth();
  </script>
</body>
</html>