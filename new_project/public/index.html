<!DOCTYPE html>
<html lang="ru" class="dark">
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Монитор линий</title>
  <script src="theme.js"></script>
  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen">
  <button onclick="toggleTheme()" class="fixed top-2 right-2 px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded">Тема</button>
  <style>
    :root {
      --speed-color: #2563eb;
      --work-color: #16a34a;
      --idle-color: #dc2626;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --speed-color: #60a5fa;
        --work-color: #4ade80;
        --idle-color: #f87171;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div id="app" class="p-4">
    <div class="flex flex-col md:flex-row gap-4">
      <!-- Left column: list of lines and settings button -->
      <div class="w-full md:w-1/4">
        <h2 class="text-lg font-bold mb-2">Линии</h2>
        <div id="linesList" class="flex flex-col gap-2"></div>
        <button id="settingsBtn" class="mt-4 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">Настройки</button>
      </div>
      <!-- Right column: charts -->
      <div class="flex-1">
        <h2 id="lineTitle" class="text-lg font-bold mb-2">Скорость</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
          <canvas id="speedChart"></canvas>
        </div>
        <h2 class="text-lg font-bold mt-6 mb-2">Работа / Простой (30 дней)</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <div class="bg-white p-4 rounded shadow">
          <canvas id="speedChart"></canvas>
        </div>
        <h2 class="text-lg font-bold mt-6 mb-2">Работа / Простой (30 дней)</h2>
        <div class="bg-white p-4 rounded shadow">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentLine = null;
    let speedChart = null;
    let dailyChart = null;

    function getChartColors() {
      const styles = getComputedStyle(document.documentElement);
      return {
        speed: styles.getPropertyValue('--speed-color').trim(),
        work: styles.getPropertyValue('--work-color').trim(),
        idle: styles.getPropertyValue('--idle-color').trim(),
      };
    }

    function hexToRgba(hex, alpha) {
      const m = hex.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);
      if (!m) return hex;
      const r = parseInt(m[1], 16);
      const g = parseInt(m[2], 16);
      const b = parseInt(m[3], 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function applyChartColors() {
      const colors = getChartColors();
      if (speedChart) {
        speedChart.data.datasets[0].borderColor = colors.speed;
        speedChart.data.datasets[0].backgroundColor = hexToRgba(colors.speed, 0.2);
        speedChart.update();
      }
      if (dailyChart) {
        dailyChart.data.datasets[0].backgroundColor = colors.work;
        dailyChart.data.datasets[1].backgroundColor = colors.idle;
        dailyChart.update();
      }
    }

    // Create charts on first load
    function createCharts() {
      const ctx1 = document.getElementById('speedChart').getContext('2d');
      const colors = getChartColors();
    // Create charts on first load
    function createCharts() {
      const ctx1 = document.getElementById('speedChart').getContext('2d');
      speedChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Скорость (см/мин)',
              data: [],
              borderColor: colors.speed,
              backgroundColor: hexToRgba(colors.speed, 0.2),
              pointRadius: 0,
              fill: true,

              type: 'bar',
              label: 'Состояние',
              data: [],
              yAxisID: 'y1',
              backgroundColor: [],
              borderWidth: 0,
              barPercentage: 1,
              categoryPercentage: 1,
            },
            {

              label: 'Скорость (см/мин)',
              data: [],
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.2)',
              pointRadius: 0,
              fill: true,

              yAxisID: 'y',

            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'см/мин' },
            },
          },
          plugins: {
            legend: { display: false },

            y1: { display: false, min: 0, max: 1 },
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                generateLabels: (chart) => {
                  const labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                  // remove state dataset entry
                  labels.splice(0, 1);
                  labels.push({ text: 'RUN', fillStyle: 'rgba(16, 185, 129, 0.3)', strokeStyle: 'rgba(16, 185, 129, 0.3)' });
                  labels.push({ text: 'STOP', fillStyle: 'rgba(220, 38, 38, 0.3)', strokeStyle: 'rgba(220, 38, 38, 0.3)' });
                  return labels;
                },
              },
            },

          },
          plugins: {
            legend: { display: false },

          },
        },
      });
      const ctx2 = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Работа (ч)',
              data: [],
              backgroundColor: colors.work,
              backgroundColor: '#16a34a',
            },
            {
              label: 'Простой (ч)',
              data: [],
              backgroundColor: colors.idle,
              backgroundColor: '#dc2626',
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              title: { display: true, text: 'Часы' },
            },
          },
        },
      });
    }

    // Load the current status for all lines and populate the list
    async function loadStatus() {
      try {
        const res = await fetch('/status');
        const lines = await res.json();
        const container = document.getElementById('linesList');
        container.innerHTML = '';
        lines.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'p-2 bg-white dark:bg-gray-800 rounded shadow flex justify-between items-center cursor-pointer';
          div.className = 'p-2 bg-white rounded shadow flex justify-between items-center cursor-pointer';
          div.dataset.lineId = item.lineId;
          const name = item.displayName || item.lineId;
          const stateLabel = item.stateLabel;
          const speed = (item.speed && !isNaN(item.speed)) ? item.speed.toFixed(1) : '-';
          const product = item.product || '';
          div.innerHTML = `
            <div>
              <div class="font-semibold">${name}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">${stateLabel}</div>
              <div class="text-xs text-gray-400 dark:text-gray-500">Изделие: ${product || '-'}</div>
              <div class="text-sm text-gray-500">${stateLabel}</div>
              <div class="text-xs text-gray-400">Изделие: ${product || '-'}</div>
            </div>
            <div class="text-right">
              <div class="font-mono">${speed}</div>
            </div>
          `;
          div.addEventListener('click', () => {
            selectLine(item.lineId);
          });
          if (currentLine === null) {
            currentLine = item.lineId;
          }
          container.appendChild(div);
        });
        // Highlight the selected line
        Array.from(container.children).forEach((child) => {
          child.classList.remove('border', 'border-blue-500');
          if (child.dataset.lineId === currentLine) {
            child.classList.add('border', 'border-blue-500');
          }
        });
      } catch (e) {
        console.error('loadStatus', e);
      }
    }

    // Change the selected line and refresh charts
    async function selectLine(lineId) {
      currentLine = lineId;
      await updateCharts();
      // update highlight
      const container = document.getElementById('linesList');
      Array.from(container.children).forEach((child) => {
        child.classList.remove('border', 'border-blue-500');
        if (child.dataset.lineId === lineId) {
          child.classList.add('border', 'border-blue-500');
        }
      });
    }

    // Fetch chart data for the current line and update both charts
    async function updateCharts() {
      if (!currentLine) return;
      try {
        const res = await fetch('/chartdata/' + currentLine);
        const data = await res.json();
        // Speed chart
        speedChart.data.labels = data.speed.labels;
        speedChart.data.datasets[1].data = data.speed.data;
        if (Array.isArray(data.states)) {
          const colors = data.states.map((s) => (s ? 'rgba(16, 185, 129, 0.3)' : 'rgba(220, 38, 38, 0.3)'));
          speedChart.data.datasets[0].data = data.states.map(() => 1);
          speedChart.data.datasets[0].backgroundColor = colors;
        }

        speedChart.data.datasets[0].data = data.speed.data;
        speedChart.update();
        // Daily chart
        dailyChart.data.labels = data.status.labels;
        dailyChart.data.datasets[0].data = data.status.work;
        dailyChart.data.datasets[1].data = data.status.down;
        dailyChart.update();
        document.getElementById('lineTitle').textContent = `${data.status.lineName || currentLine} — скорость`;
      } catch (e) {
        console.error('updateCharts', e);
      }
    }

    // Periodically refresh status and charts
    async function periodic() {
      await loadStatus();
      await updateCharts();
      setTimeout(periodic, 15000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      createCharts();
      applyChartColors();
      loadStatus().then(() => {
        selectLine(currentLine);
      });
      periodic();
      document.getElementById('settingsBtn').addEventListener('click', () => {
        window.location.href = '/settings';
      });
    });

    const themeMedia = window.matchMedia('(prefers-color-scheme: dark)');
    themeMedia.addEventListener('change', applyChartColors);
    window.addEventListener('themechange', applyChartColors);
  </script>
</body>
</html>