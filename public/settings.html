<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Settings</h1>
  <div id="auth-section">
    <p>Введите пароль настроек:</p>
    <input type="password" id="settings-password" />
    <button id="auth-button">Открыть</button>
    <p id="auth-status"></p>
  </div>
  <div id="settings-form" style="display:none">
    <h2>Параметры</h2>
    <label>Окно усреднения (сек): <input type="number" id="windowSec" /></label><br/>
    <label>V_START: <input type="number" id="V_START" step="0.1" /></label><br/>
    <label>V_STOP: <input type="number" id="V_STOP" step="0.1" /></label><br/>
    <label>delayStart (сек): <input type="number" id="delayStart" /></label><br/>
    <label>delayStop (сек): <input type="number" id="delayStop" /></label><br/>
    <label>graphHours: <input type="number" id="graphHours" /></label><br/>
    <label>offlineTimeout: <input type="number" id="offlineTimeout" /></label><br/>
    <h3>Названия линий</h3>
    <div id="lineNames"></div>
    <button id="save-button">Сохранить</button>
    <p id="save-status"></p>
  </div>
  <script>
    async function unlock() {
      const password = document.getElementById('settings-password').value;
      try {
        const res = await fetch('/settings/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (data && data.ok) {
          document.getElementById('auth-section').style.display = 'none';
          loadSettings();
        } else {
          document.getElementById('auth-status').textContent = 'Доступ запрещён';
        }
      } catch (err) {
        document.getElementById('auth-status').textContent = 'Ошибка соединения';
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/settings/info');
        const data = await res.json();
        document.getElementById('windowSec').value = data.windowSec || 0;
        document.getElementById('V_START').value = data.V_START || 0;
        document.getElementById('V_STOP').value = data.V_STOP || 0;
        document.getElementById('delayStart').value = data.delayStart || 0;
        document.getElementById('delayStop').value = data.delayStop || 0;
        document.getElementById('graphHours').value = data.graphHours || 24;
        document.getElementById('offlineTimeout').value = data.offlineTimeout || 0;
        const container = document.getElementById('lineNames');
        container.innerHTML = '';
        if (data.lineNames) {
          for (let i = 1; i <= 13; i++) {
            const id = `line${i}`;
            const div = document.createElement('div');
            div.innerHTML = `${id}: <input type="text" id="name_${id}" value="${data.lineNames[id] || ''}">`;
            container.appendChild(div);
          }
        }
        document.getElementById('settings-form').style.display = 'block';
      } catch (err) {
        document.getElementById('auth-status').textContent = 'Не удалось загрузить настройки';
      }
    }

    async function saveSettings() {
      const payload = {
        windowSec: Number(document.getElementById('windowSec').value),
        V_START: Number(document.getElementById('V_START').value),
        V_STOP: Number(document.getElementById('V_STOP').value),
        delayStart: Number(document.getElementById('delayStart').value),
        delayStop: Number(document.getElementById('delayStop').value),
        graphHours: Number(document.getElementById('graphHours').value),
        offlineTimeout: Number(document.getElementById('offlineTimeout').value),
        lineNames: {}
      };
      for (let i = 1; i <= 13; i++) {
        const id = `line${i}`;
        payload.lineNames[id] = document.getElementById(`name_${id}`).value;
      }
      try {
        const res = await fetch('/settings/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        document.getElementById('save-status').textContent = data && data.ok ? 'Сохранено' : 'Ошибка';
      } catch (err) {
        document.getElementById('save-status').textContent = 'Ошибка сохранения';
      }
    }

    document.getElementById('auth-button').addEventListener('click', unlock);
    document.getElementById('save-button').addEventListener('click', saveSettings);
  </script>
</body>
</html>
